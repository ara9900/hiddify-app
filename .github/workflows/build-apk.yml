name: Build APK

on:
  workflow_dispatch:

env:
  IS_GITHUB_ACTIONS: 1
  CHANNEL: "dev"
  FLUTTER_VERSION: '3.38.5'
  NDK_VERSION: r28c

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: Clone everything manually
        run: |
          # کلون اصلی
          git clone https://github.com/ara9900/hiddify-app.git .
          
          # کلون hiddify-core
          git clone https://github.com/hiddify/hiddify-core.git hiddify-core
          cd hiddify-core
          git checkout 97e1b2fc936cf7929336a89e77cbaaa4742ad557
          
          # کلون sing-box
          git clone https://github.com/hiddify/hiddify-sing-box.git hiddify-sing-box
          
          # کلون ray2sing
          git clone https://github.com/hiddify/ray2sing.git ray2sing
          
          cd ..
          
          echo "=== Root ==="
          ls -la
          echo "=== Core ==="
          ls hiddify-core/
          echo "=== ray2sing ==="
          ls hiddify-core/ray2sing/
          echo "=== sing-box ==="
          ls hiddify-core/hiddify-sing-box/
          echo ""
          echo "✅ All cloned!"

      - name: Clean up disk
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: Add Swap
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Show Makefile targets
        run: grep -E 'android' Makefile | head -30

      - name: Install deps
        run: |
          make android-apk-install-deps || make android-aab-install-deps || echo "manual"
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      - name: Prepare
        run: |
          make android-apk-prepare || make android-aab-prepare || echo "done"

      - name: Build APK
        run: |
          make android-apk-release || flutter build apk --release --split-per-abi

      - name: Collect APK
        run: |
          mkdir -p out
          find . -name "*.apk" -type f
          find ./build -name "*.apk" -exec cp {} out/ \; 2>/dev/null || true
          find ./build -name "*.aab" -exec cp {} out/ \; 2>/dev/null || true
          ls -la out/

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Hiddify-APK
          path: ./out/*
          retention-days: 30
